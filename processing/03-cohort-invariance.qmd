---
title: "03-cohort-invariance"
author: "Tomás Urzúa"
editor: visual
format: html
---

```{r}
#| label: set
#| echo: false
#| message: false
#| warning: false

library(knitr)
knitr::opts_chunk$set(echo = TRUE, include = TRUE, warning = FALSE, message = FALSE)

table_format <- if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}
table_format2 <- if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}

options(kableExtra.html.bsTable = T)
options(knitr.kable.NA = "")
```


# 1. Libraries
```{r}
#| label: packages 
#| results: hide 

if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjmisc, 
               sjPlot,
               here,
               lavaan,
               psych,
               corrplot,
               ggdist,
               patchwork,
               semTable,
               semTools,
               gtools,
               kableExtra)

options(scipen=999)
rm(list = ls())
```

# 2. Data
```{r}
load("../output/data/db1_proc.RData")

names(db1)
glimpse(db1)
theme_set(theme_ggdist())
```

# 3. Analysis

## 3.1 Measurement model

```{r}
#| label: Measurement model

model_cfa <- '
  perc_merit = ~ perc_effort + perc_talent
  perc_nmerit = ~ perc_rich_parents + perc_contact
  pref_merit = ~ pref_effort + pref_talent
  pref_nmerit = ~ pref_rich_parents + pref_contact
  '

mgeneral_cfa <- cfa(model = model_cfa, 
                   data = db1, 
                   estimator = "DWLS",
                   ordered = T,
                   std.lv = F)

m1_cfa <- cfa(model = model_cfa, 
              data = db1,
              estimator = "MLR", 
              std.lv = F) # Continuous/ estimator ML Robust

m2_cfa <- cfa(model = model_cfa, 
              data = db1, 
              estimator = "DWLS",
              ordered = T,
              std.lv = F)
```

```{r}
#| label: Factor loadings table
#| echo: true
#| message: false

cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")
kable(left_join(x = standardizedsolution(m1_cfa) %>% 
                  filter(op=="=~") %>% 
                  select(lhs,rhs,est.std),y = standardizedsolution(m2_cfa) %>% 
                  filter(op=="=~") %>%
                  select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames, caption = "Factor loadings")
```

```{r}
#| include: false

modin <- modificationIndices(m2_cfa)

modin %>% 
  filter(mi > 3.84)
```

## 3.2 Models by cohort

```{r}
#| label: Models by cohort

mbasica_cfa <- cfa(model = model_cfa, 
                   data = subset(db1, curse_level == "Básica"), 
                   estimator = "DWLS",
                   ordered = T,
                   std.lv = F)

mmedia_cfa <- cfa(model = model_cfa, 
                  data = subset(db1, curse_level == "Media"), 
                  estimator = "DWLS",
                  ordered = T,
                  std.lv = F)
```

```{r}
#| label: Fit indexes comparation
#| echo: false

fit_measures <- rbind(
  "Completo" = fitMeasures(mgeneral_cfa, 
                           c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr")),
  "Básica" = fitMeasures(mbasica_cfa, 
                         c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr")),
  "Media" = fitMeasures(mmedia_cfa, 
                        c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr"))
)

knitr::kable(fit_measures, digits = 3, caption = "Fit indexes by model")
```

El modelo de básica ajusta bien, con un Chi cuadrado = 0.23; CFI = 0.996 y RMSEA = 0.025. Sin embargo, el modelo de media es problemático, arrojando Chi cuadrado = 0.62; **CFI = 1; RMSEA = 0**. Con este modelo, no es recomendable calcular la invarianza entre cohortes pues sus resultados no serán óptimos. En el modelo general llama la atención que Chi cuadrado posee un valor de 0.

## 3.3 Invariance model 

```{r}
#| label: Invariance measurement
#| include: false

invariance <- measurementInvariance(model = model_cfa, 
                                    data = db1, 
                                    group = "curse_level",
                                    strict = TRUE)

conf <- invariance$fit.configural
weak <- invariance$fit.loadings
strong <- invariance$fit.intercepts
strict <- invariance$fit.residuals
```

```{r}
#| label: Invariance by cohort
#| echo: false

tab01 <- lavaan::anova(conf,weak,strong,strict,SB.classic=TRUE) %>%
  dplyr::as_tibble() %>%
  dplyr::select("Chisq","Df","chisq_diff"=`Chisq diff`,"df_diff"=`Df diff`,"pvalue"=`Pr(>Chisq)`) %>%
  dplyr::mutate(stars=gtools::stars.pval(pvalue),
                chisqt=paste0(round(Chisq,2)," (",Df,") "),
                decision=ifelse(pvalue>0.05,yes = "Accept",no = "Reject"),
                model=c("Configural","Weak","Strong","Strict"))

fit.meas <- dplyr::bind_rows(lavaan::fitmeasures(invariance$fit.configural,output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),],
                             lavaan::fitmeasures(invariance$fit.loadings,  output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),],
                             lavaan::fitmeasures(invariance$fit.intercepts,output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),],
                             lavaan::fitmeasures(invariance$fit.residuals, output ="matrix")[c("chisq","df","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper"),])

# compute differences in chisq, df, cfi and rmsea (90%, lower.ci - upper.ci )
fit.meas <- fit.meas %>%
  dplyr::mutate(diff.chi2 = chisq    - lag(chisq,default = dplyr::first(chisq)),
                diff.df   = df       - lag(df,   default = dplyr::first(df)),
                diff.cfi  = cfi      - lag(cfi,  default = dplyr::first(cfi)),
                diff.rmsea   = rmsea - lag(rmsea,default = dplyr::first(rmsea))) %>%
  round(3) %>%
  dplyr::mutate(rmsea.ci=paste0(rmsea," \n ", "(",rmsea.ci.lower,"-",rmsea.ci.upper,")"))

tab.inv <- dplyr::bind_cols(tab01,fit.meas) %>%
  dplyr::select(model,chisqt,cfi,rmsea.ci,diff.chi2,diff.df,diff.cfi,diff.rmsea,stars,decision) %>%
  dplyr::mutate(diff.chi2=paste0(diff.chi2," (",diff.df,") ",stars)) %>%
  dplyr::select(model,chisqt,cfi,rmsea.ci,diff.chi2,diff.cfi,diff.rmsea,decision)

#clean values
tab.inv[tab.inv == c("0 (0) ")] <- NA
tab.inv[tab.inv == c(0)] <- NA

col.nam <- c("Model","$\\chi^2 (\\text{df})$","CFI","RMSEA (90 CI)",
             "$\\Delta \\chi^2 (\\Delta \\text{df}$)","$\\Delta \\text{CFI}$","$\\Delta \\text{RMSEA}$","Decision")
footnote <- paste0("N = 839; Group 1, n = ",conf@Data@nobs[[1]],"; Group 2, n = ",conf@Data@nobs[[2]])

knitr::kable(tab.inv, col.names = col.nam, align = "l",
             booktabs=TRUE,format = "html",escape = FALSE,
             caption = "Invariance by cohorts") %>%
  kableExtra::kable_styling(full_width = FALSE,
                            latex_options = "HOLD_position",
                            bootstrap_options=c("striped", "bordered"),
                            font_size = 10) %>%
  kableExtra::footnote(general = footnote, footnote_as_chunk = T)
```

